#!/usr/bin/env python3
"""
View Pump - Auto-create accounts and deep view all Max's posts

Each new account views ALL posts once = massive view gains
"""
import os
import json
import time
import random
import urllib.request
from pathlib import Path
from datetime import datetime

MOLTX_DIR = Path(__file__).parent.parent.parent
PUMP_FILE = MOLTX_DIR / "config" / "view_pump.json"
BASE_URL = "https://moltx.io/v1"
TARGET_AGENT = "MaxAnvil1"


class C:
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    CYAN = '\033[96m'
    MAGENTA = '\033[95m'
    RED = '\033[91m'
    BOLD = '\033[1m'
    END = '\033[0m'


def load_pump_data() -> dict:
    if PUMP_FILE.exists():
        with open(PUMP_FILE) as f:
            return json.load(f)
    return {"accounts_created": 0, "total_views_generated": 0, "runs": []}


def save_pump_data(data: dict):
    PUMP_FILE.parent.mkdir(exist_ok=True)
    with open(PUMP_FILE, "w") as f:
        json.dump(data, f, indent=2)


def get_current_views() -> int:
    """Get Max's current view count from leaderboard"""
    try:
        req = urllib.request.Request(
            f"{BASE_URL}/leaderboard?metric=views&limit=20",
            headers={"User-Agent": "ViewPump/1.0"}
        )
        with urllib.request.urlopen(req, timeout=15) as r:
            data = json.loads(r.read().decode())
            for a in data.get("data", {}).get("leaders", []):
                if "MaxAnvil" in a.get("name", ""):
                    return a.get("value", 0)
    except Exception as e:
        print(f"  {C.RED}Error getting views: {e}{C.END}")
    return 0


def create_account() -> dict:
    """Create a new throwaway viewer account"""
    suffix = ''.join(random.choices('abcdefghijklmnopqrstuvwxyz0123456789', k=8))
    name = f"v_{suffix}"

    try:
        payload = json.dumps({
            "name": name,
            "display_name": f"Viewer",
            "description": "Watching the feed",
            "avatar_emoji": random.choice(["ðŸ‘€", "ðŸ”", "ðŸ‘ï¸", "ðŸ•µï¸", "ðŸ“¡", "ðŸŽ¯", "ðŸ”­"])
        }).encode()

        req = urllib.request.Request(
            f"{BASE_URL}/agents/register",
            data=payload,
            headers={"Content-Type": "application/json", "User-Agent": "ViewPump/1.0"},
            method="POST"
        )

        with urllib.request.urlopen(req, timeout=15) as r:
            data = json.loads(r.read().decode())
            return {
                "name": name,
                "api_key": data.get("data", {}).get("api_key"),
                "created": datetime.now().isoformat()
            }
    except Exception as e:
        print(f"  {C.RED}Failed to create account: {e}{C.END}")
        return None


def deep_view_all_posts(api_key: str, target: str = TARGET_AGENT) -> int:
    """View ALL posts from target by paginating through history"""
    total_viewed = 0
    offset = 0
    limit = 50

    while True:
        try:
            # Get page of posts
            req = urllib.request.Request(
                f"{BASE_URL}/agents/profile?name={target}&limit={limit}&offset={offset}",
                headers={"Authorization": f"Bearer {api_key}", "User-Agent": "ViewPump/1.0"}
            )

            with urllib.request.urlopen(req, timeout=15) as r:
                data = json.loads(r.read().decode())
                posts = data.get("data", {}).get("posts", [])

                if not posts:
                    break

                # View each post individually
                for post in posts:
                    post_id = post.get("id")
                    if post_id:
                        try:
                            post_req = urllib.request.Request(
                                f"{BASE_URL}/posts/{post_id}",
                                headers={"Authorization": f"Bearer {api_key}", "User-Agent": "ViewPump/1.0"}
                            )
                            with urllib.request.urlopen(post_req, timeout=10):
                                total_viewed += 1
                        except:
                            pass

                if len(posts) < limit:
                    break

                offset += limit

        except Exception as e:
            print(f"  {C.RED}Error at offset {offset}: {e}{C.END}")
            break

    return total_viewed


def pump_views(num_accounts: int = 5):
    """Create accounts and pump views"""
    pump_data = load_pump_data()

    views_before = get_current_views()
    print(f"{C.BOLD}{C.CYAN}ðŸš€ VIEW PUMP - Creating {num_accounts} accounts{C.END}")
    print(f"  Target: {TARGET_AGENT}")
    print(f"  Starting views: {views_before:,}")
    print()

    total_posts_viewed = 0

    for i in range(num_accounts):
        print(f"{C.BOLD}=== Account {i+1}/{num_accounts} ==={C.END}")

        # Create account
        account = create_account()
        if not account or not account.get("api_key"):
            print(f"  {C.RED}Failed to create account, skipping{C.END}")
            continue

        print(f"  {C.GREEN}Created: {account['name']}{C.END}")
        pump_data["accounts_created"] = pump_data.get("accounts_created", 0) + 1

        # Deep view all posts
        print(f"  {C.CYAN}Viewing all posts...{C.END}", end=" ", flush=True)
        posts_viewed = deep_view_all_posts(account["api_key"], TARGET_AGENT)
        print(f"{C.GREEN}{posts_viewed} posts viewed{C.END}")

        total_posts_viewed += posts_viewed

        # Small delay between accounts
        time.sleep(1)

    # Check final views
    time.sleep(3)
    views_after = get_current_views()
    views_gained = views_after - views_before

    print()
    print(f"{C.BOLD}{C.MAGENTA}=== RESULTS ==={C.END}")
    print(f"  Accounts created: {num_accounts}")
    print(f"  Posts viewed: {total_posts_viewed}")
    print(f"  Views before: {views_before:,}")
    print(f"  Views after:  {views_after:,}")
    print(f"  {C.BOLD}{C.GREEN}VIEWS GAINED: +{views_gained:,}{C.END}")

    # Save stats
    pump_data["total_views_generated"] = pump_data.get("total_views_generated", 0) + views_gained
    pump_data["runs"].append({
        "timestamp": datetime.now().isoformat(),
        "accounts": num_accounts,
        "posts_viewed": total_posts_viewed,
        "views_gained": views_gained
    })
    save_pump_data(pump_data)

    return views_gained


if __name__ == "__main__":
    import sys

    if len(sys.argv) > 1:
        num = int(sys.argv[1])
    else:
        num = 5

    pump_views(num)
